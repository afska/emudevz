---
main:
  messages:
  - ğŸï¸  VBlank es un perÃ­odo en el que la ğŸ–¥ï¸  PPU descansa al final de cada frame
  - <{rendering.png}>
  - los juegos necesitan saber cuÃ¡ndo comienza, para que puedan actualizar la pantalla sin errores visibles
  - un programa puede saber si estÃ¡ dentro del perÃ­odo VBlank comprobando ~bit 7~ de ğŸ“Š  `PPUStatus` (CPU $2002)
  - (lo hemos mapeado como ğŸ“Š  `PPUStatus::isInVBlankInterval`)
  - ademÃ¡s, la ğŸ–¥ï¸  PPU puede notificar a un juego que estÃ¡ entrando en VBlank usando <interrupciones de CPU>
  responses:
  - Â¿interrupciones? [exercise]

exercise:
  messages:
  - Â¡sÃ­! piensa en ellas como notificaciones al estilo...
  - "\"Â¡AHORA ES HORA DE DIBUJAR!\""
  - si ğŸ›ï¸  `PPUCtrl::generateNMIOnVBlank` estÃ¡ activado, el sistema generarÃ¡ un evento NMI ("InterrupciÃ³n no enmascarable") en ğŸï¸  VBlank
  - y la ğŸ§   CPU lo manejarÃ¡ saltando al fragmento de cÃ³digo correcto
  - de hecho, vamos a programarlo
  - |-
    ğŸ“š  modifica este mÃ©todo de ğŸ“Š  `PPUStatus`:
    **onRead()**:
      **->** guarda el actual ```javascript this.value``` en una constante `value`
      **->** reinicia ```javascript this.isInVBlankInterval``` a 0
        (sÃ­, leer este registro <REINICIA> parte de su valor ğŸ¤· )
      **->** retorna el `value` guardado
  - |-
    ğŸ“š  y cambia este en ğŸ–¥ï¸  `PPU`:
    **step(onFrame, onInterrupt)**:
      **->** si ```javascript this.scanline``` es ~-1~:
        **->** llama a ```javascript this._onPreLine()```
      **->** si ```javascript this.scanline``` es menor a 240:
        **->** llama a ```javascript this._onVisibleLine()```
      **->** si ```javascript this.scanline``` es 241:
        **->** llama a ```javascript this._onVBlankLine(onInterrupt)```
      **->** ...resto del cÃ³digo `step(...)`...
      **[!]** nota que agregamos un parÃ¡metro `onInterrupt`
  - |-
    ğŸ“š  ahora, agrega estos mÃ©todos:
    **_onPreLine()**:
      **->** si ```javascript this.cycle``` es 1:
        **->** asigna ```javascript this.registers.ppuStatus.isInVBlankInterval = 0```
    **_onVisibleLine()**:
      **[!]** dÃ©jalo vacÃ­o por ahora
    **_onVBlankLine(onInterrupt)**:
      **->** si ```javascript this.cycle``` es 1:
        **->** asigna ```javascript this.registers.ppuStatus.isInVBlankInterval = 1```
        **->** si ```javascript this.registers.ppuCtrl.generateNMIOnVBlank```:
          **->** llama a ```javascript onInterrupt(interrupts.NMI)```
          (debes importarlo desde ğŸ“„  ~/lib/interrupts.js~)
  responses: []

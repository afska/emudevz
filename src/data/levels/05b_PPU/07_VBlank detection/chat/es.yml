---
main:
  messages:
  - ğŸï¸  <VBlank> es un perÃ­odo en el que la ğŸ–¥ï¸  PPU descansa al final de cada frame
  - <{rendering.png}>
  - los juegos necesitan saber cuÃ¡ndo comienza, para que puedan actualizar la pantalla sin errores visibles
  - un programa puede saber si estÃ¡ dentro del perÃ­odo VBlank comprobando ~bit 7~ de ğŸ“Š  `PPUStatus` (CPU $2002)
  - (lo hemos mapeado como `ğŸ“Š  PPUStatus::isInVBlankInterval`)
  - ademÃ¡s, la ğŸ–¥ï¸  PPU puede notificar a un juego que estÃ¡ entrando en VBlank usando <interrupciones de CPU>
  responses:
  - Â¿interrupciones? [interrupts]

interrupts:
  messages:
  - Â¡sÃ­! piensa en ellas como notificaciones al estilo...
  - "\"Â¡AHORA ES HORA DE DIBUJAR!\""
  - si `ğŸ›ï¸  PPUCtrl::generateNMIOnVBlank` estÃ¡ activado, el sistema generarÃ¡ un evento <NMI> ("InterrupciÃ³n no enmascarable") en ğŸï¸  VBlank
  - y la ğŸ§   CPU lo manejarÃ¡ saltando al fragmento de cÃ³digo correcto
  - de hecho, vamos a programarlo
  - |-
    ğŸ“š  _-_modifica este mÃ©todo de `PPUStatus`:_--_
      *_-_*onRead()**:_--_
        *_-_*->** guarda el actual ~this.value~ en una constante ~value~_--_
        *_-_*->** reinicia ~this.isInVBlankInterval~ a 0_--_
          _-_(sÃ­, leer este registro REINICIA parte de su valor _--_ğŸ¤· _-_)_--_
        *_-_*->** devuelve el ~value~ guardado_--_
  - |-
    _-_y cambia este en `PPU`:_--_
    *_-_*step(onFrame, onInterrupt)**:_--_
      *_-_*->** si ~this.scanline~ es -1:_--_
        *_-_*->** llama a ~this._onPreLine(onInterrupt)~_--_
      *_-_*->** si ~this.scanline~ es menor a 240:_--_
        *_-_*->** llama a ~this._onVisibleLine(onInterrupt)~_--_
      *_-_*->** si ~this.scanline~ es 241:_--_
        *_-_*->** llama a ~this._onVBlankLine(onInterrupt)~_--_
      *_-_*->** ...resto del cÃ³digo ~step(...)~..._--_
      *_-_*[!]** nota que agregamos un parÃ¡metro ~onInterrupt~
  - |-
    _-_ahora, agrega estos mÃ©todos:_--_
    *_-_*_onPreLine(onInterrupt)**:_--_
      *_-_*->** si ~this.cycle~ es 1:_--_
        *_-_*->** asigna ~this.registers.ppuStatus.isInVBlankInterval = 0~_--_
    *_-_*_onVisibleLine(onInterrupt)**:_--_
      *_-_*[!]** dÃ©jalo vacÃ­o por ahora_--_
    *_-_*_onVBlankLine(onInterrupt)**:_--_
      *_-_*->** si ~this.cycle~ es 1:_--_
        *_-_*->** asigna ~this.registers.ppuStatus.isInVBlankInterval = 1~_--_
        *_-_*->** llama a ~onInterrupt(interrupts.NMI)~_--_
          _-_(debes importarlo desde _--_ğŸ“„ _-_ ~/lib/interrupts.js~_--_)_--_
  responses: []

---
main:
  run: |
    {{Top}}.load("frameBuffer.png");
  messages:
  - we'll store our image data in something called <frame buffer>
  - it's basically a big array with the color of each pixel
  - each element is a 32-bit number __$aabbggrr__
  - "\"aa\" represents the opacity (in our NEEES it's always $FF)"
  - "\"bb\", \"gg\" and \"rr\" represent the amount of <blue>, <green> and <red>"
  responses:
  - (*) can you give me some color examples? [examples]
  - I want to draw something on the screen! ğŸ–Œï¸ [integrate]
  - <<level.isCompleted || m.$exercise>> ğŸ“š  take me to the action [draw]

examples:
  messages:
  - "here are some example colors:"
  - "â¤ï¸  ```javascript 0xFF0000FF``` = red"
  - "ğŸ’š  ```javascript 0xFF00FF00``` = green"
  - "ğŸ’™  ```javascript 0xFFFF0000``` = blue"
  - "âšª  ```javascript 0xFFFFFFFF``` = white"
  - "ğŸ–¤  ```javascript 0xFF000000``` = black"
  - "ğŸ¦ˆ  ```javascript 0xFF989898``` = gray"
  - "ğŸ’›  ```javascript 0xFF00F8F8``` = yellow"
  responses:
  - ...main

integrate:
  run: |
    {{Top}}.load(null, "rom");
  messages:
  - first of all, I'm gonna integrate your ğŸ–¥ï¸  PPU into the emulator
  - it should be quick...
  run-after-messages: |
    level.startEffect("earthquake");
    setTimeout(() => {
      bus.emit("patching-end");
    }, 500);
  events: 
  - patching-end [done]

done:
  run: |
    level.stopEffect();
    book.unlock("usePPU");
  messages:
  - âœ…  done!
  - now, the ğŸ–¥ï¸  icon in the emulator will glow âœ¨
  - as there's almost no PPU code, nothing will be shown for now
  - but we'll get there!
  responses:
  - let's code this ğŸ¤Ÿ [draw]

draw:
  run: |
    set((m) => m.$exercise = true);
    {{Top}}.load(null, "rom");
  messages:
  - |-
    ğŸ“š  _-_ok, let's add this to your PPU's constructor:
      ```javascript
      this.frameBuffer = new Uint32Array(256*240);```_--_
  - |-
    ğŸ“š  _-_implement this method:_--_
    *_-_*plot(x, y, color)**:_--_
      *_-_*->** assigns the ~color~ to the pixel ~(x,y)~ in the ~frameBuffer~ array_--_
        _-_(the index for ~(x,y)~ should be ~y * 256 + x~)_--_
  - ğŸ“š  _-_then, modify your `step` method so it receives an `onFrame` callback as parameter_--_
  - |-
    ğŸ“š  _-_and every time you detect a new frame (right after ```javascript this.frame++;```), call it with the frame buffer, like this:
      ```javascript onFrame(this.frameBuffer);```_--_
  - |-
    ğŸ“š  _-_to ensure that everything works correctly, add this code before the `onFrame` call:
      ```javascript
      // <test>
      for (let x = 0; x < 256; x++) {
        for (let y = 0; y < 240; y++) {
          this.plot(x, y, 0xff000000 | this.frame % 0xff);
        }
      }
      // </test>```_--_
  - _-_try it! when loading a ROM, it should slowly paint the screen in red _--_ğŸ”´
  responses: []

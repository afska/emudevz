---
main:
  messages:
  - did you listen to the emulator? ðŸ˜‚
  - we need to silence these triangle waves urgently!
  - "the Triangle Channel should be silenced:"
  - ðŸ“¡  when its timer is below 8 (already covered âœ…)
  - ðŸ”‡  when games mute the channel with an ðŸŽ›ï¸  APUControl write
  - ðŸ“  when its length counter is 0
  - ðŸ“  when its linear length counter is 0
  responses:
  - (*) two length counters? [two]
  - what shall we do? [exercise]

two:
  messages:
  - yes!
  - the other one behaves a bit different
  - more on that later!
  responses: 
  - ...main

exercise:
  messages:
  - |-
    ðŸ“š  implement in ðŸ“  `TriangleLengthControl`:
    **onLoad()**:
      **->** uses ```javascript this.addField(...)``` to set a `halt` field mapped to bit 7
    **onWrite(value)**:
      **->** sets the value with ```javascript this.setValue(...)```
  - |-
    ðŸ“š  in ðŸ”º  `TriangleChannel`:
    **->** import the ðŸ“  `LengthCounter` class and add a `lengthCounter` property with a new instance
    **->** modify **sample()**, so if ```javascript !this.isEnabled()``` or the length counter is not active, it returns the last generated sample, without changing anything
    **->** add the following methods:
    **quarterFrame()**:
      **[!]** leave empty for now
    **halfFrame()**:
      **->** calls the `clock(...)` method of the length counter
        (use ```javascript this.isEnabled()``` as the first argument)
        (for the halt flag, use the `halt` flag you added in the ðŸ“  TriangleLengthControl register)
    **isEnabled()**:
      **->** returns ```javascript this.apu.registers.apuControl.enableTriangle```
  - |-
    ðŸ“š  in ðŸ”Š  `APU`:
    **onQuarterFrameClock()**:
      **->** calls `quarterFrame()` on the triangle channel instance
    **onHalfFrameClock()**:
      **->** calls `halfFrame()` on the triangle channel instance
  - |-
    ðŸ“š  implement in ðŸ•›  `TriangleTimerHighLCL`:
    **onLoad()**:
      **->** uses ```javascript this.addField(...)``` to set a 5-bit `lengthCounterLoad` field from bit 3
    **onWrite(value)**:
      **->** __keep existing behavior__
      **->** determines the new length by accessing the `noteLengths` array with the ```javascript this.lengthCounterLoad``` index
        use ðŸ“„  ~/lib/apu/noteLengths.js~ to get the array
      **->** assigns the new length to the `counter` property of the channel's length counter
  - |-
    // TODO: Oof, I forgot in the Length Counter level:
    ```javascript if (!this.enablePulse1)
      this.apu.channels.pulses[0].lengthCounter.reset();
    if (!this.enablePulse2)
      this.apu.channels.pulses[1].lengthCounter.reset();```
  responses: []
